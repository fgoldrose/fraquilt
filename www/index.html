<!DOCTYPE html>
<html>
<head>
    <title>Fraquilt</title>
</head>
<body>
    <main>
        
        <label>Iterations</label>
        <input type="number" id="iter" value="10" style="width:50px">
        <label>Width</label>
        <input type="number" id="width" value="2" style="width:50px">
        <label>Colors</label>
        <input type="number" id="colors" value="1" style="width:50px">
        <button onClick="generateImage()">Generate</button>
        <br>
        <img src="" style="image-rendering: pixelated; image-rendering: -moz-crisp-edges; min-height: 500px; min-width: 500px" id="generate">
        
    </main>
    <script>
        function hexToRGB(hex) {
            var bigint = parseInt(hex.slice(1), 16);
            var r = (bigint >> 16) & 255;
            var g = (bigint >> 8) & 255;
            var b = bigint & 255;

            return [r,g,b];
        }


/*
        function randVal(numcols, likelynum){
            let n = Math.random();
            if(n < 0.1){
                return (Math.floor(Math.random() * 255)).toString(10)
            }
            else if(n < likelynum){
                return (Math.floor(Math.random() * 3) + 1).toString(10)
            }
            else{
                let c = Math.floor(Math.random() * 3)
                let i = Math.floor(Math.random() * numcols);
                if(c == 0){
                    return "r" + i.toString(10)
                }
                else if(c == 1){
                    return "g" + i.toString(10)
                }
                else {
                    return "b" + i.toString(10)
                }
            } 
        }*/

        function randVal(numcols, likelynum, numrange){
            let n = Math.random();
            if(n < likelynum){
                return (Math.floor(Math.random() * numrange)).toString(10)
            }
            else{
                let c = Math.floor(Math.random() * 3)
                let i = Math.floor(Math.random() * numcols);
                if(c == 0){
                    return "r" + i.toString(10)
                }
                else if(c == 1){
                    return "g" + i.toString(10)
                }
                else {
                    return "b" + i.toString(10)
                }
            }
        } 

        function randOp(){
            /*
            let o = Math.random()
            if(o < 0.1){
                return "-";
            }
            else if(o < 0.4){
                return "+";
            }
            else if(o < 0.7){
                return "/"
            }
            else{
                return "*"
            }*/
            
            let o = Math.floor(Math.random() * 4);
            switch(o){
                case 0:
                    return "+";
                case 1:
                    return "-";
                case 2:
                    return "*";
                case 3:
                    return "/";
            }
        }

        function randFuncs(numcols, width,height, likely1, likely2, likely3, numrange){
            let res = []
            for(let w=0; w < width; w++){
                let warr = []
                for(let h=0; h < height; h++){
                    let harr = []
                    for(let color=0; color < numcols; color++){
                        let colarr = []
                        for(let comp=0; comp < 3; comp++){

                            if(Math.random() < likely1){
                                colarr.push(randVal(numcols, likely2, numrange) + randOp() + randVal(numcols, likely3, numrange))
                            }
                            else{
                                colarr.push(randVal(numcols, 0, numrange));
                            }
                        }
                        harr.push(colarr)
                    }
                    warr.push(harr)
                }
                res.push(warr)
            }
            return res
        }

        function randColors(numcolors){
            let cols = []
            for(let i=0; i < numcolors; i++){
                let r = Math.floor(Math.random() * 256);
                let g = Math.floor(Math.random() * 256);
                let b = Math.floor(Math.random() * 256);
                cols.push([r,g,b]);
            }
            return cols;
        }

        function generateImage(){
            let numcols = parseInt(colors.value);
            let randc = randColors(numcols);
            let randf = randFuncs(numcols, parseInt(width.value), parseInt(width.value), Math.random(), Math.random()/2, Math.random()/2, Math.floor(Math.random() * 256));
            const data = {
                "iterations" : parseInt(iter.value),
                "colors" : randc,
                "functions": randf
            }

            const url = '/api'
            const req = {
                method: 'POST',
                headers : {'Content-Type' : 'application/json'},
                body: JSON.stringify(data)
             }

             fetch(url, req)
                .then(res => {
                    res.json().then(data => {
                        if(res.status == 200){
                            generate.setAttribute('src', data.img)
                        }
                    })
                })
        }

        function getImage(data){
            fetch(data.url, {method: 'HEAD'})
                .then(r => {
                    if(r.status == 202){
                        setTimeout(() => getImage(data), 500);
                    }
                    else if(r.status == 200){
                        generate.setAttribute('src', data.url)
                    }
                    else{
                        console.error(r.status)
                    }
            })
        }
    </script>
</body>
</html>